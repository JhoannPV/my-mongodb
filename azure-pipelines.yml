name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main

pool:
  name: agent2

variables:
  dockerRegistryServiceConnection: dockerhub-connection
  imageRepository: jalbertobohorquez/mongodb
  imageTag: $(Build.BuildId)
  k8sNamespace: calendar-app
  deploymentName: mongodb
  containerName: mongodb

stages:
  - stage: Build_Push
    displayName: Build and Push Image
    jobs:
      - job: build_push
        steps:
          - checkout: self

          - task: Docker@2
            displayName: Build and Push to Docker Hub
            inputs:
              command: buildAndPush
              containerRegistry: $(dockerRegistryServiceConnection)
              repository: $(imageRepository)
              dockerfile: $(Build.SourcesDirectory)/Dockerfile
              buildContext: $(Build.SourcesDirectory)
              tags: |
                $(imageTag)
                latest

  - stage: Deploy
    displayName: Update Kubernetes Deployment
    dependsOn: Build_Push
    jobs:
      - job: deploy
        steps:
          - script: |
              microk8s kubectl -n $(k8sNamespace) set image deployment/$(deploymentName) $(containerName)=docker.io/$(imageRepository):$(imageTag)
            displayName: Set image on deployment
          - script: |
              microk8s kubectl -n $(k8sNamespace) rollout status deployment/$(deploymentName) --timeout=300s
            displayName: Wait for rollout

